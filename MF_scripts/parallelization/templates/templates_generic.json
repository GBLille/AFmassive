{
    "alignment": "#!/bin/bash\n\n# slurm parameters to launch on cpu\n\n# activate AF/MF conda env\n# e.g: module load massivefold/1.0.0\n\n# fixed variables\nrun_alphafold_path= #e.g.:'run_alphafold_path=/gpfslocalsup/pub/anaconda-py3/2023.03/envs/MassiveFold-1.0.0/bin/run_alphafold.py' for jean zay cluster\ndata_dir= #e.g.:'data_dir=/shared/databases/2023-07-31'\nmax_template_date=2023-07-31\n\noutput=../output_array/\nuse_precomputed_msas=false\nalignments_only=true\nmax_template_date=2023-07-31\n\n# variables to adapt: used for alignment\njobname=$jobname\nfafile=../input/$$jobname.fasta\nmodel_preset=$substitute_model_preset\ndb_preset=$substitute_db_preset\nbfd_max_hits=$substitute_bfd_max_hits\nmgnify_max_hits=$substitute_mgnify_max_hits\nuniprot_max_hits=$ubstitute_uniprot_max_hits\nuniref_max_hits=$substitute_uniref\nno_templates=$substitute_no_templates\n\n# variable to ignore: unused for alignment\nnum_predictions_per_model=5\ndropout=false\ndropout_rates_filename=\nmax_recycles=20\nearly_stop_tolerance=0.5\nmodels_to_use=\nstart_prediction=1\nmodels_to_relax=none\nuse_gpu_relax=false\n\ndate\n\necho \"python3 $${run_alphafold_path}\n    --fasta_paths=$${fafile}\n    --output_dir=$${output}\n    --data_dir=$${data_dir}\n    --db_preset=$${db_preset}\n    --model_preset=$${model_preset}\n    --models_to_relax=$${models_to_relax}\n    --use_gpu_relax=$${use_gpu_relax}\n    --max_template_date=$${max_template_date}\n    --use_precomputed_msas=$${use_precomputed_msas}\n    --num_predictions_per_model=$${num_predictions_per_model}\n    --alignments_only=$${alignments_only}\n    --dropout=$${dropout}\n    --dropout_rates_filename=$${dropout_rates_filename}\n    --max_recycles=$${max_recycles}\n    --early_stop_tolerance=$${early_stop_tolerance}\n    --bfd_max_hits=$${bfd_max_hits}\n    --mgnify_max_hits=$${mgnify_max_hits}\n    --uniprot_max_hits=$${uniprot_max_hits}\n    --uniref_max_hits=$${uniref_max_hits}\n    --models_to_use=$${models_to_use}\n    --start_prediction=$${start_prediction}\n    --no_templates=$${no_templates}\n    --uniref90_database_path=$${data_dir}/uniref90/uniref90.fasta\n    --mgnify_database_path=$${data_dir}/mgnify/mgy_clusters_2022_05.fa\n    --template_mmcif_dir=$${data_dir}/pdb_mmcif/mmcif_files\n    --obsolete_pdbs_path=$${data_dir}/pdb_mmcif/obsolete.dat\n    --bfd_database_path=$${data_dir}/bfd/bfd_metaclust_clu_complete_id30_c90_final_seq.sorted_opt\n    --pdb_seqres_database_path=$${data_dir}/pdb_seqres/pdb_seqres.txt\n    --uniref30_database_path=$${data_dir}/uniref30/UniRef30_2021_03\n    --uniprot_database_path=$${data_dir}/uniprot/uniprot.fasta\"\n\ntime python3 ${run_alphafold_path} \\\n    --fasta_paths=$${fafile} \\\n    --output_dir=$${output} \\\n    --data_dir=$${data_dir} \\\n    --db_preset=$${db_preset} \\\n    --model_preset=$${model_preset} \\\n    --models_to_relax=$${models_to_relax} \\\n    --use_gpu_relax=$${use_gpu_relax} \\\n    --max_template_date=$${max_template_date} \\\n    --use_precomputed_msas=$${use_precomputed_msas} \\\n    --num_predictions_per_model=$${num_predictions_per_model} \\\n    --alignments_only=$${alignments_only} \\\n    --dropout=$${dropout} \\\n    --dropout_rates_filename=$${dropout_rates_filename} \\\n    --max_recycles=$${max_recycles} \\\n    --early_stop_tolerance=$${early_stop_tolerance} \\\n    --bfd_max_hits=$${bfd_max_hits} \\\n    --mgnify_max_hits=$${mgnify_max_hits} \\\n    --uniprot_max_hits=$${uniprot_max_hits} \\\n    --uniref_max_hits=$${uniref_max_hits} \\\n    --models_to_use=$${models_to_use} \\\n    --start_prediction=$${start_prediction} \\\n    --no_templates=$${no_templates} \\\n    --uniref90_database_path=$${data_dir}/uniref90/uniref90.fasta \\\n    --mgnify_database_path=$${data_dir}/mgnify/mgy_clusters_2022_05.fa \\\n    --template_mmcif_dir=$${data_dir}/pdb_mmcif/mmcif_files \\\n    --obsolete_pdbs_path=$${data_dir}/pdb_mmcif/obsolete.dat \\\n    --bfd_database_path=$${data_dir}/bfd/bfd_metaclust_clu_complete_id30_c90_final_seq.sorted_opt \\\n    --pdb_seqres_database_path=$${data_dir}/pdb_seqres/pdb_seqres.txt \\\n    --uniref30_database_path=$${data_dir}/uniref30/UniRef30_2021_03 \\\n    --uniprot_database_path=$${data_dir}/uniprot/uniprot.fasta\n\ndate\n",
    "jobarray": "#!/bin/bash\n\n# slurm parameters depending on your config \n\ndate\n\n# for memory\nexport TF_FORCE_UNIFIED_MEMORY=1\nexport XLA_PYTHON_CLIENT_MEM_FRACTION=4.0\n\n# fixed variables\nrun_alphafold_path= #e.g.:/gpfslocalsup/pub/anaconda-py3/2023.03/envs/MassiveFold-1.0.0/bin/run_alphafold.py on jean zay cluster\ndata_dir= #e.g.:/shared/databases/2023-07-31\nmax_template_date=2023-07-31\nuse_precomputed_msas=true\nalignments_only=false\n\n# variables to adapt\ncurrent_dir=$$(realpath .)\njobname=$jobname\nname=$$(basename -s .slurm $$jobname)\nfafile=../input/$${name}.fasta\nmodel_preset=$substitute_model_preset\ndb_preset=$substitute_db_preset\nuse_gpu_relax=$substitute_use_gpu_relax\nmodels_to_relax=$substitute_models_to_relax\ndropout=$substitute_dropout\ndropout_rates_filename=$substitute_dropout_rates_filename\nmax_recycles=$substitute_max_recycles\nearly_stop_tolerance=$substitute_early_stop_tolerance\nbfd_max_hits=$substitute_bfd_max_hits\nmgnify_max_hits=$substitute_mgnify_max_hits\nuniprot_max_hits=$substitute_uniprot_max_hits\nuniref_max_hits=$substitute_uniref_max_hits\nno_templates=$substitute_no_templates\n\n# parameters for each task in the job array\nmodels_json=batches.json\nbatch_model=$$(./get_batch.py --batch_id $$SLURM_ARRAY_TASK_ID --element model)\nbatch_start=$$(./get_batch.py --batch_id $$SLURM_ARRAY_TASK_ID --element start)\nbatch_end=$$(./get_batch.py --batch_id $$SLURM_ARRAY_TASK_ID --element end)\n\nmodels_to_use=$$batch_model\n\necho Model used is $$batch_model, batch computed between prediction $$batch_start and $$batch_end\n\noutput_dir=\"../output_array/$${name}/batch_$${SLURM_ARRAY_TASK_ID}_$${name}\"\necho output_dir is $$output_dir\nmkdir -vp $${output_dir}/$${name}\necho\nln -s $$current_dir/../output_array/$${name}/msas $${output_dir}/$${name}\n\ndate\n\necho \"python3 $${run_alphafold_path}\n    --fasta_paths=$${fafile}\n    --output_dir=$${output_dir}\n    --data_dir=$${data_dir}\n    --db_preset=$${db_preset}\n    --model_preset=$${model_preset}\n    --models_to_relax=$${models_to_relax}\n    --use_gpu_relax=$${use_gpu_relax}\n    --max_template_date=$${max_template_date}\n    --use_precomputed_msas=$${use_precomputed_msas}\n    --num_predictions_per_model=$${batch_end}\n    --alignments_only=$${alignments_only}\n    --dropout=$${dropout}\n    --dropout_rates_filename=$${dropout_rates_filename}\n    --max_recycles=$${max_recycles}\n    --early_stop_tolerance=$${early_stop_tolerance}\n    --bfd_max_hits=$${bfd_max_hits}\n    --mgnify_max_hits=$${mgnify_max_hits}\n    --uniprot_max_hits=$${uniprot_max_hits}\n    --uniref_max_hits=$${uniref_max_hits}\n    --models_to_use=$${models_to_use}\n    --start_prediction=$${batch_start}\n    --no_templates=$${no_templates}\n    --uniref90_database_path=$${data_dir}/uniref90/uniref90.fasta\n    --mgnify_database_path=$${data_dir}/mgnify/mgy_clusters_2022_05.fa\n    --template_mmcif_dir=$${data_dir}/pdb_mmcif/mmcif_files\n    --obsolete_pdbs_path=$${data_dir}/pdb_mmcif/obsolete.dat\n    --bfd_database_path=$${data_dir}/bfd/bfd_metaclust_clu_complete_id30_c90_final_seq.sorted_opt\n    --pdb_seqres_database_path=$${data_dir}/pdb_seqres/pdb_seqres.txt\n    --uniref30_database_path=$${data_dir}/uniref30/UniRef30_2021_03\n    --uniprot_database_path=$${data_dir}/uniprot/uniprot.fasta\"\n\ntime python3 $${run_alphafold_path} \\\n    --fasta_paths=$${fafile} \\\n    --output_dir=$${output_dir} \\\n    --data_dir=$${data_dir} \\\n    --db_preset=$${db_preset} \\\n    --model_preset=$${model_preset} \\\n    --models_to_relax=$${models_to_relax} \\\n    --use_gpu_relax=$${use_gpu_relax} \\\n    --max_template_date=$${max_template_date} \\\n    --use_precomputed_msas=$${use_precomputed_msas} \\\n    --num_predictions_per_model=$${batch_end} \\\n    --alignments_only=$${alignments_only} \\\n    --dropout=$${dropout} \\\n    --dropout_rates_filename=$${dropout_rates_filename} \\\n    --max_recycles=$${max_recycles} \\\n    --early_stop_tolerance=$${early_stop_tolerance} \\\n    --bfd_max_hits=$${bfd_max_hits} \\\n    --mgnify_max_hits=$${mgnify_max_hits} \\\n    --uniprot_max_hits=$${uniprot_max_hits} \\\n    --uniref_max_hits=$${uniref_max_hits} \\\n    --models_to_use=$${models_to_use} \\\n    --start_prediction=$${batch_start} \\\n    --no_templates=$${no_templates} \\\n    --uniref90_database_path=$${data_dir}/uniref90/uniref90.fasta \\\n    --mgnify_database_path=$${data_dir}/mgnify/mgy_clusters_2022_05.fa \\\n    --template_mmcif_dir=$${data_dir}/pdb_mmcif/mmcif_files \\\n    --obsolete_pdbs_path=$${data_dir}/pdb_mmcif/obsolete.dat \\\n    --bfd_database_path=$${data_dir}/bfd/bfd_metaclust_clu_complete_id30_c90_final_seq.sorted_opt \\\n    --pdb_seqres_database_path=$${data_dir}/pdb_seqres/pdb_seqres.txt \\\n    --uniref30_database_path=$${data_dir}/uniref30/UniRef30_2021_03 \\\n    --uniprot_database_path=$${data_dir}/uniprot/uniprot.fasta\n\ndate\n",
    "post_treatment": "#!/bin/bash\n\n# slurm parameters to launch on cpu\n\n# activate AF/MF conda env\n# e.g: module load massivefold/1.0.0\n\nmf_plots_path=\nsequence_name=$jobname\noutput=../output_array\n\n# rename and move files\necho \"time ./organize_outputs.py --batches_path $$output/$$sequence_name\"\ntime ./organize_outputs.py --batches_path $$output/$$sequence_name\n\n# delete not needed files\nrm -r $$output/$$sequence_name/batch_*\n\n# plots\necho \"Generating plots\"\necho \"python3 $${mf_plots_path}\n  --input_path $${output}/$${sequence_name}\n  --plot_type for_each\n  --top_n_predictions 5\n  --chosen_plots coverage,DM_plddt_PAE\"\n\n\ntime python3 $${mf_plots_path} \\\n  --input_path $${output}/$${sequence_name} \\\n  --plot_type for_each \\\n  --top_n_predictions 5  \\\n  --chosen_plots coverage,DM_plddt_PAE\n\ndate\n"
}