{
    "alignment": "#!/bin/bash\n\n#SBATCH --partition base\n#SBATCH --nodes=1\n#SBATCH --ntasks-per-node=16\n#SBATCH --mem=40G\n##SBATCH --gpus-per-node=1\n##SBATCH --gres=gpu:1\n#SBATCH -o ../log/%x.o%j\n\nmodule purge\nmodule load massivefold/1.0.0\n\n\njobname=$jobname\nfafile=../input/$$jobname.fasta\noutput=../output_array/\n\ndata_dir=/shared/databases/2023-07-31\nmodel_preset=multimer\nmax_template_date=2023-07-31\ndb_preset=full_dbs\nnum_predictions_per_model=5\nalignments_only=true\ndropout=false\ndropout_rates_filename=\nmax_recycles=20\nearly_stop_tolerance=0.5\nbfd_max_hits=100000\nmgnify_max_hits=501\nuniprot_max_hits=50000\nuniref_max_hits=10000\nmodels_to_use=\nstart_prediction=1\nno_templates=false\nmodels_to_relax=none\nuse_gpu_relax=false\nuse_precomputed_msas=false\n\ndate\n\necho \"massivefold-1.0.0\n    --fasta_paths=$${fafile}\n    --output_dir=$${output}\n    --data_dir=$${data_dir}\n    --db_preset=$${db_preset}\n    --model_preset=$${model_preset}\n    --models_to_relax=$${models_to_relax}\n    --use_gpu_relax=$${use_gpu_relax}\n    --max_template_date=$${max_template_date}\n    --use_precomputed_msas=$${use_precomputed_msas}\n    --num_predictions_per_model=$${num_predictions_per_model}\n    --alignments_only=$${alignments_only}\n    --dropout=$${dropout}\n    --dropout_rates_filename=$${dropout_rates_filename}\n    --max_recycles=$${max_recycles}\n    --early_stop_tolerance=$${early_stop_tolerance}\n    --bfd_max_hits=$${bfd_max_hits}\n    --mgnify_max_hits=$${mgnify_max_hits}\n    --uniprot_max_hits=$${uniprot_max_hits}\n    --uniref_max_hits=$${uniref_max_hits}\n    --models_to_use=$${models_to_use}\n    --start_prediction=$${start_prediction}\n    --no_templates=$${no_templates}\n    --uniref90_database_path=$${data_dir}/uniref90/uniref90.fasta\n    --mgnify_database_path=$${data_dir}/mgnify/mgy_clusters_2022_05.fa\n    --template_mmcif_dir=$${data_dir}/pdb_mmcif/mmcif_files\n    --obsolete_pdbs_path=$${data_dir}/pdb_mmcif/obsolete.dat\n    --bfd_database_path=$${data_dir}/bfd/bfd_metaclust_clu_complete_id30_c90_final_seq.sorted_opt\n    --pdb_seqres_database_path=$${data_dir}/pdb_seqres/pdb_seqres.txt\n    --uniref30_database_path=$${data_dir}/uniref30/UniRef30_2021_03\n    --uniprot_database_path=$${data_dir}/uniprot/uniprot.fasta\"\n\ntime massivefold-1.0.0 \\\n    --fasta_paths=$${fafile} \\\n    --output_dir=$${output} \\\n    --data_dir=$${data_dir} \\\n    --db_preset=$${db_preset} \\\n    --model_preset=$${model_preset} \\\n    --models_to_relax=$${models_to_relax} \\\n    --use_gpu_relax=$${use_gpu_relax} \\\n    --max_template_date=$${max_template_date} \\\n    --use_precomputed_msas=$${use_precomputed_msas} \\\n    --num_predictions_per_model=$${num_predictions_per_model} \\\n    --alignments_only=$${alignments_only} \\\n    --dropout=$${dropout} \\\n    --dropout_rates_filename=$${dropout_rates_filename} \\\n    --max_recycles=$${max_recycles} \\\n    --early_stop_tolerance=$${early_stop_tolerance} \\\n    --bfd_max_hits=$${bfd_max_hits} \\\n    --mgnify_max_hits=$${mgnify_max_hits} \\\n    --uniprot_max_hits=$${uniprot_max_hits} \\\n    --uniref_max_hits=$${uniref_max_hits} \\\n    --models_to_use=$${models_to_use} \\\n    --start_prediction=$${start_prediction} \\\n    --no_templates=$${no_templates} \\\n    --uniref90_database_path=$${data_dir}/uniref90/uniref90.fasta \\\n    --mgnify_database_path=$${data_dir}/mgnify/mgy_clusters_2022_05.fa \\\n    --template_mmcif_dir=$${data_dir}/pdb_mmcif/mmcif_files \\\n    --obsolete_pdbs_path=$${data_dir}/pdb_mmcif/obsolete.dat \\\n    --bfd_database_path=$${data_dir}/bfd/bfd_metaclust_clu_complete_id30_c90_final_seq.sorted_opt \\\n    --pdb_seqres_database_path=$${data_dir}/pdb_seqres/pdb_seqres.txt \\\n    --uniref30_database_path=$${data_dir}/uniref30/UniRef30_2021_03 \\\n    --uniprot_database_path=$${data_dir}/uniprot/uniprot.fasta\n\ndate\n",
    "jobarray": "#!/bin/bash\n\n#SBATCH --partition=base\n#SBATCH --nodes=1\n#SBATCH --ntasks-per-node=16\n#SBATCH --mem=200G\n#SBATCH --gpus-per-node=1\n#SBATCH --gres=gpu:1\n#SBATCH -o ../log/%x.o%j\n#SBATCH --array=0-$substitute_batch_number\n\ndate\n\nmodule purge\nmodule load massivefold/1.0.0\n\n#for memory\nexport TF_FORCE_UNIFIED_MEMORY=1\nexport XLA_PYTHON_CLIENT_MEM_FRACTION=4.0\n\n#variables to adapt\ndata_dir=/shared/databases/2023-07-31\nmodel_preset=$substitute_model_preset\nmax_template_date=2023-07-31\ndb_preset=full_dbs\nuse_gpu_relax=true\nuse_precomputed_msas=true\nmodels_to_relax=best\nalignments_only=false\ndropout=$substitute_dropout\ndropout_rates_filename=\nmax_recycles=20\nearly_stop_tolerance=0.5\nbfd_max_hits=100000\nmgnify_max_hits=501\nuniprot_max_hits=50000\nuniref_max_hits=10000\nno_templates=$substitute_no_templates\n\njobname=$jobname\nname=$$(basename -s .slurm $$jobname)\nfafile=../input/$${name}.fasta\n\nmodels_json=batches.json\nbatch_model=$$(./get_batch.py --batch_id $$SLURM_ARRAY_TASK_ID --element model)\nbatch_start=$$(./get_batch.py --batch_id $$SLURM_ARRAY_TASK_ID --element start)\nbatch_end=$$(./get_batch.py --batch_id $$SLURM_ARRAY_TASK_ID --element end)\n\nmodels_to_use=$$batch_model\n\necho Model used is $$batch_model, batch computed between prediction $$batch_start and $$batch_end\n\noutput_dir=\"../output_array/$${name}/batch_$${SLURM_ARRAY_TASK_ID}_$${name}\"\necho output_dir is $$output_dir\nmkdir -vp $${output_dir}/$${name}\necho\nln -s /home/\"$$USER\"/massivefold_runs/output_array/$${name}/msas $${output_dir}/$${name}\n\ndate\n\necho \"massivefold-1.0.0\n    --fasta_paths=$${fafile}\n    --output_dir=$${output_dir}\n    --data_dir=$${data_dir}\n    --db_preset=$${db_preset}\n    --model_preset=$${model_preset}\n    --models_to_relax=$${models_to_relax}\n    --use_gpu_relax=$${use_gpu_relax}\n    --max_template_date=$${max_template_date}\n    --use_precomputed_msas=$${use_precomputed_msas}\n    --num_predictions_per_model=$${batch_end}\n    --alignments_only=$${alignments_only}\n    --dropout=$${dropout}\n    --dropout_rates_filename=$${dropout_rates_filename}\n    --max_recycles=$${max_recycles}\n    --early_stop_tolerance=$${early_stop_tolerance}\n    --bfd_max_hits=$${bfd_max_hits}\n    --mgnify_max_hits=$${mgnify_max_hits}\n    --uniprot_max_hits=$${uniprot_max_hits}\n    --uniref_max_hits=$${uniref_max_hits}\n    --models_to_use=$${models_to_use}\n    --start_prediction=$${batch_start}\n    --no_templates=$${no_templates}\n    --uniref90_database_path=$${data_dir}/uniref90/uniref90.fasta\n    --mgnify_database_path=$${data_dir}/mgnify/mgy_clusters_2022_05.fa\n    --template_mmcif_dir=$${data_dir}/pdb_mmcif/mmcif_files\n    --obsolete_pdbs_path=$${data_dir}/pdb_mmcif/obsolete.dat\n    --bfd_database_path=$${data_dir}/bfd/bfd_metaclust_clu_complete_id30_c90_final_seq.sorted_opt\n    --pdb_seqres_database_path=$${data_dir}/pdb_seqres/pdb_seqres.txt\n    --uniref30_database_path=$${data_dir}/uniref30/UniRef30_2021_03\n    --uniprot_database_path=$${data_dir}/uniprot/uniprot.fasta\"\n\ntime massivefold-1.0.0 \\\n    --fasta_paths=$${fafile} \\\n    --output_dir=$${output_dir} \\\n    --data_dir=$${data_dir} \\\n    --db_preset=$${db_preset} \\\n    --model_preset=$${model_preset} \\\n    --models_to_relax=$${models_to_relax} \\\n    --use_gpu_relax=$${use_gpu_relax} \\\n    --max_template_date=$${max_template_date} \\\n    --use_precomputed_msas=$${use_precomputed_msas} \\\n    --num_predictions_per_model=$${batch_end} \\\n    --alignments_only=$${alignments_only} \\\n    --dropout=$${dropout} \\\n    --dropout_rates_filename=$${dropout_rates_filename} \\\n    --max_recycles=$${max_recycles} \\\n    --early_stop_tolerance=$${early_stop_tolerance} \\\n    --bfd_max_hits=$${bfd_max_hits} \\\n    --mgnify_max_hits=$${mgnify_max_hits} \\\n    --uniprot_max_hits=$${uniprot_max_hits} \\\n    --uniref_max_hits=$${uniref_max_hits} \\\n    --models_to_use=$${models_to_use} \\\n    --start_prediction=$${batch_start} \\\n    --no_templates=$${no_templates} \\\n    --uniref90_database_path=$${data_dir}/uniref90/uniref90.fasta \\\n    --mgnify_database_path=$${data_dir}/mgnify/mgy_clusters_2022_05.fa \\\n    --template_mmcif_dir=$${data_dir}/pdb_mmcif/mmcif_files \\\n    --obsolete_pdbs_path=$${data_dir}/pdb_mmcif/obsolete.dat \\\n    --bfd_database_path=$${data_dir}/bfd/bfd_metaclust_clu_complete_id30_c90_final_seq.sorted_opt \\\n    --pdb_seqres_database_path=$${data_dir}/pdb_seqres/pdb_seqres.txt \\\n    --uniref30_database_path=$${data_dir}/uniref30/UniRef30_2021_03 \\\n    --uniprot_database_path=$${data_dir}/uniprot/uniprot.fasta\n\ndate\n",
    "post_treatment": "#!/bin/bash\n\n#SBATCH --partition base\n#SBATCH --nodes=1\n#SBATCH --ntasks-per-node=16\n#SBATCH --mem=40G\n##SBATCH --gpus-per-node=1\n##SBATCH --gres=gpu:1\n#SBATCH -o ../log/%x.o%j\n\ndate\n\nsource /ugsf/software/miniconda3/etc/profile.d/conda.sh\nwhile test \"$$CONDA_PREFIX\"\ndo\n    conda deactivate\ndone\n\nconda activate massivefold-1.0.0\nmodule load massivefold/1.0.0\ndate\n\nsequence_name=$jobname\noutput=../output_array\n\n# rename and move files\necho \"time ./organize_outputs.py --batches_path $$output/$$sequence_name\"\ntime ./organize_outputs.py --batches_path $$output/$$sequence_name\n\n# delete not needed files\nrm -r $$output/$$sequence_name/batch_*\n\n# plots\necho \"Generating plots\"\necho \"massivefold-1.0.0_plots --input_path $${output}/$${sequence_name} --plot_type for_each --top_n_predictions 5 --chosen_plots coverage,DM_plddt_PAE\"\n\ntime massivefold-1.0.0_plots --input_path $${output}/$${sequence_name} --plot_type for_each --top_n_predictions 5  --chosen_plots coverage,DM_plddt_PAE\n\ndate\n"
}