{
    "alignment": "#!/usr/bin/env bash\n\n#SBATCH --nodes=1            # Number of nodes\n#SBATCH --ntasks-per-node=1  # Number of tasks per node\n#SBATCH --cpus-per-task=10    # Number of OpenMP threads per task\n##SBATCH --gpus-per-node=1    # Number of GPUs per node\n##SBATCH -C a100              # Use A100 partition\n#SBATCH --hint=nomultithread # Disable hyperthreading\n##SBATCH --job-name=MF_alignment # Jobname\n#SBATCH --output=../log/%x.o%j      # Output file %x is the jobname, %j the jobid\n#SBATCH --error=../log/%x.o%j       # Error file\n#SBATCH --time=10:00:00      # Expected runtime HH:MM:SS (max 100h)\n#SBATCH --account=fvp@cpu #\n##\n## Please, refer to comments below for\n## more information about these 4 last options.\n##SBATCH --account=<account>@a100      # To specify cpu accounting: <account> = echo $$IDRPROJ\n##SBATCH --partition=<partition>       # To specify partition (see IDRIS web site for more info)\n##SBATCH --qos=qos_gpu-dev             # Uncomment for job requiring less than 2 hours\n##SBATCH --qos=qos_gpu-t4              # Uncomment for job requiring more than 20h (max 16 GPUs)\n\nmodule purge\nmodule load cpuarch/amd\n#module load alphafold/2.3.1\nmodule purge\nmodule load massivefold/1.0.0\n\nexport TMP=$$JOBSCRATCH\nexport TMPDIR=$$JOBSCRATCH\nexport ALPHAFOLDDB=/gpfsdswork/dataset/AlphaFold-2.3.1\n\n\njobname=$jobname\nfafile=../input/$${jobname}.fasta\noutput=../output_array/\n\ndata_dir=$${ALPHAFOLDDB}/model_parameters/2.3.1\ndatabase_dir=$${ALPHAFOLDDB}\nmodel_preset=multimer\nmax_template_date=2023-07-31\ndb_preset=full_dbs\nnum_predictions_per_model=5\nalignments_only=true\ndropout=false\ndropout_rates_filename=\nmax_recycles=20\nearly_stop_tolerance=0.5\nbfd_max_hits=100000\nmgnify_max_hits=501\nuniprot_max_hits=50000\nuniref_max_hits=10000\nmodels_to_use=\nstart_prediction=1\nno_templates=false\nmodels_to_relax=none\nuse_gpu_relax=false\nuse_precomputed_msas=false\n\ndate\n\necho \"python3 $$(which run_alphafold.py)\n    --fasta_paths=$${fafile}\n    --output_dir=$${output}\n    --data_dir=$${data_dir}\n    --db_preset=$${db_preset}\n    --model_preset=$${model_preset}\n    --models_to_relax=$${models_to_relax}\n    --use_gpu_relax=$${use_gpu_relax}\n    --max_template_date=$${max_template_date}\n    --use_precomputed_msas=$${use_precomputed_msas}\n    --num_predictions_per_model=$${num_predictions_per_model}\n    --alignments_only=$${alignments_only}\n    --dropout=$${dropout}\n    --dropout_rates_filename=$${dropout_rates_filename}\n    --max_recycles=$${max_recycles}\n    --early_stop_tolerance=$${early_stop_tolerance}\n    --bfd_max_hits=$${bfd_max_hits}\n    --mgnify_max_hits=$${mgnify_max_hits}\n    --uniprot_max_hits=$${uniprot_max_hits}\n    --uniref_max_hits=$${uniref_max_hits}\n    --models_to_use=$${models_to_use}\n    --start_prediction=$${start_prediction}\n    --no_templates=$${no_templates}\n    --uniref90_database_path=$${database_dir}/uniref90/uniref90.fasta\n    --mgnify_database_path=$${database_dir}/mgnify/mgy_clusters_2022_05.fa\n    --template_mmcif_dir=$${database_dir}/pdb_mmcif\n    --obsolete_pdbs_path=$${database_dir}/pdb_mmcif/obsolete.dat\n    --bfd_database_path=$${database_dir}/bfd/bfd_metaclust_clu_complete_id30_c90_final_seq.sorted_opt\n    --pdb_seqres_database_path=$${database_dir}/pdb_seqres/pdb_seqres.txt\n    --uniref30_database_path=$${database_dir}/uniref30/UniRef30_2021_03\n    --uniprot_database_path=$${database_dir}/uniprot/uniprot.fasta\"\n\ntime python3 $$(which run_alphafold.py) \\\n    --fasta_paths=$${fafile} \\\n    --output_dir=$${output} \\\n    --data_dir=$${data_dir} \\\n    --db_preset=$${db_preset} \\\n    --model_preset=$${model_preset} \\\n    --models_to_relax=$${models_to_relax} \\\n    --use_gpu_relax=$${use_gpu_relax} \\\n    --max_template_date=$${max_template_date} \\\n    --use_precomputed_msas=$${use_precomputed_msas} \\\n    --num_predictions_per_model=$${num_predictions_per_model} \\\n    --alignments_only=$${alignments_only} \\\n    --dropout=$${dropout} \\\n    --dropout_rates_filename=$${dropout_rates_filename} \\\n    --max_recycles=$${max_recycles} \\\n    --early_stop_tolerance=$${early_stop_tolerance} \\\n    --bfd_max_hits=$${bfd_max_hits} \\\n    --mgnify_max_hits=$${mgnify_max_hits} \\\n    --uniprot_max_hits=$${uniprot_max_hits} \\\n    --uniref_max_hits=$${uniref_max_hits} \\\n    --models_to_use=$${models_to_use} \\\n    --start_prediction=$${start_prediction} \\\n    --no_templates=$${no_templates} \\\n    --uniref90_database_path=$${database_dir}/uniref90/uniref90.fasta \\\n    --mgnify_database_path=$${database_dir}/mgnify/mgy_clusters_2022_05.fa \\\n    --template_mmcif_dir=$${database_dir}/pdb_mmcif \\\n    --obsolete_pdbs_path=$${database_dir}/pdb_mmcif/obsolete.dat \\\n    --bfd_database_path=$${database_dir}/bfd/bfd_metaclust_clu_complete_id30_c90_final_seq.sorted_opt \\\n    --pdb_seqres_database_path=$${database_dir}/pdb_seqres/pdb_seqres.txt \\\n    --uniref30_database_path=$${database_dir}/uniref30/UniRef30_2021_03 \\\n    --uniprot_database_path=$${database_dir}/uniprot/uniprot.fasta\n\ndate\n",
    "jobarray": "#!/usr/bin/env bash\n##SBATCH --job-name=MF_inference\n#SBATCH --account=$jeanzay_account\n\n#SBATCH --error=../log_urh/%x.%j\n#SBATCH --output=../log_urh/%x.%j\n\n#SBATCH --nodes=1\n#SBATCH --ntasks-per-node=1\n#SBATCH --cpus-per-task=8\n#SBATCH --hint=nomultithread\n#SBATCH --gpus-per-node=1\n#SBATCH --array=0-$substitute_batch_number\n#SBATCH --time=19:50:00\n##SBATCH --qos=qos_gpu-t4         # Uncomment for job requiring more than 20h (max 16 GPUs)\n#SBATCH -C $jeanzay_full_gpu             # Use gpu\n\nmodule purge\n#module load cpuarch/amd\nmodule load massivefold/1.0.0\n\nexport TF_FORCE_UNIFIED_MEMORY='1'\nexport XLA_PYTHON_CLIENT_MEM_FRACTION='4.0'\n\nexport TMP=$$JOBSCRATCH\nexport TMPDIR=$$JOBSCRATCH\nexport ALPHAFOLDDB=/gpfsdswork/dataset/AlphaFold-2.3.1\n\n#variables to adapt\njobname=$jobname\nname=$$(basename -s .slurm $$jobname)\nfafile=../input/$${name}.fasta\n\n\noutput_dir=\"../output_array/$${name}/batch_$${SLURM_ARRAY_TASK_ID}_$${name}\"\necho output_dir is $$output_dir\nmkdir -vp $${output_dir}/$${name}\n\ncurrent_dir=$$(realpath .)\nln -s $$current_dir/../output_array/$${name}/msas $${output_dir}/$${name}\n\ndata_dir=$${ALPHAFOLDDB}/model_parameters/2.3.1\nmodel_preset=multimer\nmax_template_date=2023-07-31\ndb_preset=full_dbs\nuse_gpu_relax=true\nuse_precomputed_msas=true\nmodels_to_relax=best\nalignments_only=false\ndropout=true\ndropout_rates_filename=\nmax_recycles=21\nearly_stop_tolerance=0.5\nbfd_max_hits=100000\nmgnify_max_hits=501\nuniprot_max_hits=50000\nuniref_max_hits=10000\nno_templates=true\n\nmodels_json=batches.json\nbatch_model=$$(./get_batch.py --batch_id $$SLURM_ARRAY_TASK_ID --element model)\nbatch_start=$$(./get_batch.py --batch_id $$SLURM_ARRAY_TASK_ID --element start)\nbatch_end=$$(./get_batch.py --batch_id $$SLURM_ARRAY_TASK_ID --element end)\n\nmodels_to_use=$$batch_model\necho Model used is $$batch_model, batch computed between prediction $$batch_start and $$batch_end\n\ndate\n\necho \"python3 $$(which run_alphafold.py)\n    --fasta_paths=$${fafile}\n    --output_dir=$${output_dir}\n    --data_dir=$${data_dir}\n    --db_preset=$${db_preset}\n    --model_preset=$${model_preset}\n    --models_to_relax=$${models_to_relax}\n    --use_gpu_relax=$${use_gpu_relax}\n    --max_template_date=$${max_template_date}\n    --use_precomputed_msas=$${use_precomputed_msas}\n    --num_predictions_per_model=$${batch_end}\n    --alignments_only=$${alignments_only}\n    --dropout=$${dropout}\n    --dropout_rates_filename=$${dropout_rates_filename}\n    --max_recycles=$${max_recycles}\n    --early_stop_tolerance=$${early_stop_tolerance}\n    --bfd_max_hits=$${bfd_max_hits}\n    --mgnify_max_hits=$${mgnify_max_hits}\n    --uniprot_max_hits=$${uniprot_max_hits}\n    --uniref_max_hits=$${uniref_max_hits}\n    --models_to_use=$${models_to_use}\n    --start_prediction=$${batch_start}\n    --no_templates=$${no_templates}\n    --uniref90_database_path=$${ALPHAFOLDDB}/uniref90/uniref90.fasta\n    --mgnify_database_path=$${ALPHAFOLDDB}/mgnify/mgy_clusters_2022_05.fa\n    --template_mmcif_dir=$${ALPHAFOLDDB}/pdb_mmcif\n    --obsolete_pdbs_path=$${ALPHAFOLDDB}/pdb_mmcif/obsolete.dat\n    --bfd_database_path=$${ALPHAFOLDDB}/bfd/bfd_metaclust_clu_complete_id30_c90_final_seq.sorted_opt\n    --pdb_seqres_database_path=$${ALPHAFOLDDB}/pdb_seqres/pdb_seqres.txt\n    --uniref30_database_path=$${ALPHAFOLDDB}/uniref30/UniRef30_2021_03\n    --uniprot_database_path=$${ALPHAFOLDDB}/uniprot/uniprot.fasta\"\n\ntime python3 $$(which run_alphafold.py) \\\n    --fasta_paths=$${fafile} \\\n    --output_dir=$${output_dir} \\\n    --data_dir=$${data_dir} \\\n    --db_preset=$${db_preset} \\\n    --model_preset=$${model_preset} \\\n    --models_to_relax=$${models_to_relax} \\\n    --use_gpu_relax=$${use_gpu_relax} \\\n    --max_template_date=$${max_template_date} \\\n    --use_precomputed_msas=$${use_precomputed_msas} \\\n    --num_predictions_per_model=$${batch_end} \\\n    --alignments_only=$${alignments_only} \\\n    --dropout=$${dropout} \\\n    --dropout_rates_filename=$${dropout_rates_filename} \\\n    --max_recycles=$${max_recycles} \\\n    --early_stop_tolerance=$${early_stop_tolerance} \\\n    --bfd_max_hits=$${bfd_max_hits} \\\n    --mgnify_max_hits=$${mgnify_max_hits} \\\n    --uniprot_max_hits=$${uniprot_max_hits} \\\n    --uniref_max_hits=$${uniref_max_hits} \\\n    --models_to_use=$${models_to_use} \\\n    --start_prediction=$${batch_start} \\\n    --no_templates=$${no_templates} \\\n    --uniref90_database_path=$${ALPHAFOLDDB}/uniref90/uniref90.fasta \\\n    --mgnify_database_path=$${ALPHAFOLDDB}/mgnify/mgy_clusters_2022_05.fa \\\n    --template_mmcif_dir=$${ALPHAFOLDDB}/pdb_mmcif \\\n    --obsolete_pdbs_path=$${ALPHAFOLDDB}/pdb_mmcif/obsolete.dat \\\n    --bfd_database_path=$${ALPHAFOLDDB}/bfd/bfd_metaclust_clu_complete_id30_c90_final_seq.sorted_opt \\\n    --pdb_seqres_database_path=$${ALPHAFOLDDB}/pdb_seqres/pdb_seqres.txt \\\n    --uniref30_database_path=$${ALPHAFOLDDB}/uniref30/UniRef30_2021_03 \\\n    --uniprot_database_path=$${ALPHAFOLDDB}/uniprot/uniprot.fasta\n\ndate\n\n",
    "post_treatment": "#!/bin/bash\n\n#SBATCH --nodes=1            # Number of nodes\n#SBATCH --ntasks-per-node=1  # Number of tasks per node\n#SBATCH --cpus-per-task=10    # Number of OpenMP threads per task\n##SBATCH --gpus-per-node=1    # Number of GPUs per node\n##SBATCH -C $jeanzay_full_gpu              # Use A100 partition\n#SBATCH --hint=nomultithread # Disable hyperthreading\n##SBATCH --job-name=MF_post_treatment # Jobname\n#SBATCH --output=../log/%x.o%j      # Output file %x is the jobname, %j the jobid\n#SBATCH --error=../log/%x.o%j       # Error file\n#SBATCH --time=10:00:00      # Expected runtime HH:MM:SS (max 100h)\n#SBATCH --account=fvp@cpu #\n##\n## Please, refer to comments below for\n## more information about these 4 last options.\n##SBATCH --account=<account>@a100      # To specify cpu accounting: <account> = echo $$IDRPROJ\n##SBATCH --partition=<partition>       # To specify partition (see IDRIS web site for more info)\n##SBATCH --qos=qos_gpu-dev             # Uncomment for job requiring less than 2 hours\n##SBATCH --qos=qos_gpu-t4              # Uncomment for job requiring more than 20h (max 16 GPUs)\n\nmodule purge\nmodule load cpuarch/amd\n#module load alphafold/2.3.1\nmodule purge\nmodule load massivefold/1.0.0\n\nsequence_name=$jobname\noutput=../output_array\n\n# rename and move files\necho \"time ./organize_outputs.py --batches_path $$output/$$sequence_name\"\ntime ./organize_outputs.py --batches_path $$output/$$sequence_name\n\n# delete not needed files\nrm -r $$output/$$sequence_name/batch_*\n\n# plots\necho \"Generating plots\"\n\necho \"python3 /gpfswork/rech/fvp/commun/plots/MF_plots.py --input_path $${output}/$${sequence_name} --plot_type for_each --top_n_predictions 5 --chosen_plots coverage,DM_plddt_PAE\"\ntime python3 /gpfswork/rech/fvp/commun/plots/MF_plots.py --input_path $${output}/$${sequence_name} --plot_type for_each --top_n_predictions 5 --chosen_plots coverage,DM_plddt_PAE\n\necho \"python3 /gpfswork/rech/fvp/commun/plots/MF_plots.py --input_path $${output}/$${sequence_name} --top_n_predictions 5 --chosen_plots CF_PAEs\"\ntime python3 /gpfswork/rech/fvp/commun/plots/MF_plots.py --input_path $${output}/$${sequence_name} --top_n_predictions 5 --chosen_plots CF_PAEs\n\ndate\n"
}